<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–û–±–º–µ–Ω –§–ª–æ—Ä–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #1c1c1e);
            --text-color: var(--tg-theme-text-color, #ffffff);
            --hint-color: var(--tg-theme-hint-color, #9e9e9e);
            --button-color: var(--tg-theme-button-color, #2ea6ff);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #2c2c2e);
            
            /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —Ç–∏–ø–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π */
            --buy-gradient: linear-gradient(135deg, #2ea6ff 0%, #007aff 100%);
            --sell-gradient: linear-gradient(135deg, #ff9f0a 0%, #ff3b30 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --card-radius: 20px;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }

        /* –§–æ–Ω–æ–≤—ã–µ –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø—è—Ç–Ω–∞ */
        .glow-bg {
            position: absolute;
            width: 300px;
            height: 300px;
            background: var(--button-color);
            filter: blur(120px);
            opacity: 0.15;
            z-index: -1;
            border-radius: 50%;
            top: -50px;
        }

        .container {
            width: 100%;
            max-width: 380px;
            display: none; /* –°–∫—Ä—ã—Ç–æ –¥–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ */
            flex-direction: column;
            gap: 20px;
            animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –æ–±–º–µ–Ω–∞ */
        .trade-card {
            background-color: var(--secondary-bg);
            border-radius: var(--card-radius);
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .header-icon {
            font-size: 52px;
            margin-bottom: 12px;
            filter: drop-shadow(0 0 15px rgba(255,255,255,0.2));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        h1 {
            font-size: 22px;
            font-weight: 800;
            margin: 0 0 4px 0;
            letter-spacing: -0.5px;
        }

        .subtitle {
            color: var(--hint-color);
            font-size: 14px;
            margin-bottom: 24px;
        }

        /* –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–º–µ–Ω–∞ (–û—Ç–¥–∞—é -> –ü–æ–ª—É—á–∞—é) */
        .exchange-visual {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }

        .exchange-row {
            background: var(--bg-color);
            border-radius: 14px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exchange-label {
            font-size: 12px;
            color: var(--hint-color);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .currency-value {
            font-size: 20px;
            font-weight: 700;
        }

        .currency-name {
            font-size: 14px;
            opacity: 0.7;
            font-weight: 500;
        }

        /* –°—Ç—Ä–µ–ª–æ—á–∫–∞ –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ */
        .swap-arrow {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: var(--secondary-bg);
            border: 4px solid var(--secondary-bg);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--hint-color);
            z-index: 2;
        }

        /* –ì–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
        .main-btn {
            background: var(--button-color);
            color: var(--button-text-color);
            border: none;
            border-radius: 14px;
            padding: 18px;
            font-size: 17px;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 20px -6px var(--button-color);
        }

        .main-btn:active {
            transform: scale(0.97);
            opacity: 0.9;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤ */
        .mode-buy .main-btn {
            background: var(--buy-gradient);
            box-shadow: 0 8px 20px -6px #2ea6ff;
        }

        .mode-sell .main-btn {
            background: var(--sell-gradient);
            box-shadow: 0 8px 20px -6px #ff9f0a;
        }

        .mode-sell .currency-value {
            color: #ff9f0a; /* –ê–∫—Ü–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ */
        }
        
        .mode-buy .currency-value {
            color: #2ea6ff; /* –ê–∫—Ü–µ–Ω—Ç –¥–ª—è –ø–æ–∫—É–ø–∫–∏ */
        }

        /* –≠–∫—Ä–∞–Ω –æ—à–∏–±–∫–∏ */
        .access-denied {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }

        .access-denied .emoji {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        /* Loader –Ω–∞ –∫–Ω–æ–ø–∫–µ */
        .loader {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <div class="glow-bg"></div>

    <div id="app" class="container">
        <div class="trade-card">
            <div id="action-icon" class="header-icon">üí†</div>
            <h1 id="action-title">–û–±–º–µ–Ω</h1>
            <div class="subtitle">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ —Å–¥–µ–ª–∫–∏</div>

            <div class="exchange-visual">
                <div class="exchange-row">
                    <div>
                        <div class="exchange-label">–í—ã –æ—Ç–¥–∞–µ—Ç–µ</div>
                        <div class="currency-value" id="pay-amount">0</div>
                    </div>
                    <div class="currency-name" id="pay-currency">CUR</div>
                </div>

                <div class="swap-arrow">‚Üì</div>

                <div class="exchange-row">
                    <div>
                        <div class="exchange-label">–í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ</div>
                        <div class="currency-value" id="receive-amount">0</div>
                    </div>
                    <div class="currency-name" id="receive-currency">CUR</div>
                </div>
            </div>
        </div>

        <button class="main-btn" id="confirm-btn">
            <span id="btn-text">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</span>
            <div class="loader" id="btn-loader"></div>
        </button>
        
        <div style="text-align: center; color: var(--hint-color); font-size: 12px; margin-top: -10px;">
            –ö—É—Ä—Å –æ–±–º–µ–Ω–∞: 1 –§–ª–æ—Ä–∏ = 3 –†–æ—Å—Ç–∏
        </div>
    </div>

    <div id="denied" class="access-denied">
        <div class="emoji">üö´</div>
        <h2>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h2>
        <p style="color: var(--hint-color); margin: 10px 0 30px;">–≠—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞<br>–¥–ª—è –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.</p>
        <button class="main-btn" onclick="Telegram.WebApp.close()" style="background: var(--secondary-bg); color: var(--text-color); box-shadow: none;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); 
        tg.enableClosingConfirmation();
    
        const API_URL = 'https://kalel-rookier-reverentially.ngrok-free.dev/api/exchange/validate'; // –ó–ê–ú–ï–ù–ò–¢–ï –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω
    
        const params = new URLSearchParams(window.location.search);
        const buyAmount = params.get('buy');
        const sellAmount = params.get('sell');
        const targetId = params.get('id'); 
    
        const appDiv = document.getElementById('app');
        const deniedDiv = document.getElementById('denied');
        
        const titleEl = document.getElementById('action-title');
        const iconEl = document.getElementById('action-icon');
        const btnEl = document.getElementById('confirm-btn');
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');
        
        const payAmountEl = document.getElementById('pay-amount');
        const payCurrencyEl = document.getElementById('pay-currency');
        const receiveAmountEl = document.getElementById('receive-amount');
        const receiveCurrencyEl = document.getElementById('receive-currency');
    
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        const currentUser = tg.initDataUnsafe?.user;
        const currentUserId = currentUser ? String(currentUser.id) : null;
    
        if (currentUserId && targetId && currentUserId !== targetId) {
            deniedDiv.style.display = 'flex';
            tg.HapticFeedback.notificationOccurred('error');
        } else {
            appDiv.style.display = 'flex';
            initInterface();
        }
    
        function initInterface() {
            let actionType = '';
            let amountIn = 0;
            let amountOut = 0;
            const RATE = 3; 
    
            if (buyAmount) {
                actionType = 'buy';
                appDiv.classList.add('mode-buy');
                
                amountOut = parseInt(buyAmount);
                amountIn = amountOut * RATE;
    
                titleEl.textContent = "–ü–æ–∫—É–ø–∫–∞ –§–ª–æ—Ä–∏";
                iconEl.textContent = "üíé";
                
                payAmountEl.textContent = amountIn;
                payCurrencyEl.textContent = "–†–û–°–¢–ò ü™ô";
                
                receiveAmountEl.textContent = amountOut;
                receiveCurrencyEl.textContent = "–§–õ–û–†–ò üíé";
    
                btnText.textContent = `–ö–£–ü–ò–¢–¨ –ó–ê ${amountIn} –†–û–°–¢–ò`;
    
            } else if (sellAmount) {
                actionType = 'sell';
                appDiv.classList.add('mode-sell');
                
                amountIn = parseInt(sellAmount);
                amountOut = amountIn * RATE;
    
                titleEl.textContent = "–ü—Ä–æ–¥–∞–∂–∞ –§–ª–æ—Ä–∏";
                iconEl.textContent = "‚öñÔ∏è";
                
                payAmountEl.textContent = amountIn;
                payCurrencyEl.textContent = "–§–õ–û–†–ò üíé";
                
                receiveAmountEl.textContent = amountOut;
                receiveCurrencyEl.textContent = "–†–û–°–¢–ò ü™ô";
    
                btnText.textContent = `–ü–†–û–î–ê–¢–¨ –ó–ê ${amountOut} –†–û–°–¢–ò`;
                
            } else {
                titleEl.textContent = "–û—à–∏–±–∫–∞";
                btnEl.style.display = 'none';
                return;
            }
    
            btnEl.addEventListener('click', async () => {
                tg.HapticFeedback.impactOccurred('heavy');
    
                btnText.style.display = 'none';
                btnLoader.style.display = 'block';
                btnEl.style.pointerEvents = 'none';
    
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            initData: tg.initData,
                            action: actionType,
                            amount: actionType === 'buy' ? amountOut : amountIn
                        })
                    });
    
                    const result = await response.json();
    
                    if (response.ok && result.success) {
                        tg.HapticFeedback.notificationOccurred('success');
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                        btnText.textContent = '‚úÖ –£–°–ü–ï–®–ù–û';
                        btnText.style.display = 'block';
                        btnLoader.style.display = 'none';
                        
                        setTimeout(() => {
                            tg.close();
                        }, 1000);
                    } else {
                        throw new Error(result.error || result.detail || '–û—à–∏–±–∫–∞ –æ–±–º–µ–Ω–∞');
                    }
    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    tg.HapticFeedback.notificationOccurred('error');
                    
                    btnText.textContent = '‚ùå ' + (error.message || '–û–®–ò–ë–ö–ê');
                    btnText.style.display = 'block';
                    btnLoader.style.display = 'none';
                    btnEl.style.pointerEvents = 'auto';
                    
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        btnText.textContent = actionType === 'buy' 
                            ? `–ö–£–ü–ò–¢–¨ –ó–ê ${amountIn} –†–û–°–¢–ò`
                            : `–ü–†–û–î–ê–¢–¨ –ó–ê ${amountOut} –†–û–°–¢–ò`;
                    }, 2000);
                }
            });
        }
    </script>
</body>
</html>
